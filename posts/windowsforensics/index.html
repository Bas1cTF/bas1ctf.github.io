<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#D9389C}</style><title>Windows Forensics 1</title><meta name=description content=".::CTF PLAYER::."><meta name=keywords content="Bas1c,HTB,writeup,TryHackme"><meta property="og:url" content="https://bas1ctf.github.io/posts/windowsforensics/"><meta property="og:type" content="website"><meta property="og:title" content="Windows Forensics 1"><meta property="og:description" content=".::CTF PLAYER::."><meta property="og:image" content="/images/ghost.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Windows Forensics 1"><meta name=twitter:description content=".::CTF PLAYER::."><meta property="twitter:domain" content="https://bas1ctf.github.io/posts/windowsforensics/"><meta property="twitter:url" content="https://bas1ctf.github.io/posts/windowsforensics/"><meta name=twitter:image content="/images/ghost.png"><link rel=canonical href=https://bas1ctf.github.io/posts/windowsforensics/><link rel=stylesheet type=text/css href=https://bas1ctf.github.io//css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://bas1ctf.github.io//css/main.css><link disabled id=dark-theme rel=stylesheet href=https://bas1ctf.github.io//css/dark.css><script src=https://bas1ctf.github.io//js/svg-injector.min.js></script>
<script src=https://bas1ctf.github.io//js/feather-icons.min.js></script>
<script src=https://bas1ctf.github.io//js/main.js></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://bas1ctf.github.io/><img src=https://bas1ctf.github.io//images/ghost.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://bas1ctf.github.io/>Bas1c</a></div><div class=nav-links><div class=nav-link><a href=https://bas1ctf.github.io/><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://bas1ctf.github.io/posts/><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://bas1ctf.github.io/tags/><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/Bas1cTF><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://bas1ctf.github.io/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://bas1ctf.github.io/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://bas1ctf.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/Bas1cTF><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Windows Forensics 1</h1><small role=doc-subtitle></small><p class=post-date>August 30, 2022</p><ul class=post-tags><li class=post-tag><a href=https://bas1ctf.github.io/tags/tryhackme>TryHackme</a></li></ul></div><div class=post-content><p><h2 id=registros-de-windows>Registros de Windows</h2><p><em>Artefactos (Artifacts),</em> es la evidencia dejada por los usuarios al interactuar con el sistema.</p><p>Los <strong>registros de Windows</strong> son bases de datos que almacenan la configuración de sistema del usuario (hardware, software o información del usuario), archivos usados recientemente, programas usados, o dispositivos conectados al sistema.
Se conforma de llaves y valores, al observarlos a traves de regedit.exe se pueden distinguir a las llaves como los folders y el valor de la llave son los datos almacenados en esta.
<em>Registry Hive,</em> es un grupo de llaves, subllaves y sus valores, almacenados en un solo archivo en el disco.
En cualquier sistema Windows tenemos cinco llaves principales:</p><ol><li>HKEY_CURRENT_USER</li><li>HKEY_HKEY_USERS</li><li>HKEY_LOCAL_MACHINE</li><li>HKEY_CLASSES_ROOT</li><li>HKEY_CURRENT_CONFIG</li></ol><p><img src=/images/windows-forensics/tabla.png alt=Clasificacion></p><h2 id=registry-hives-offline>Registry Hives offline</h2><p>Acceder a los registros en una imagen del disco no es posible hacerlo desde regedit, para eso es necesario saber en donde se encuentran, la mayoria de las hives se localizan en el directorio <code>C:\Windows\System32\Config</code> las cuales son:</p><ol><li>DEFAULT - <code>HKEY_USERS\DEFAULT</code></li><li>SAM - <code>HKEY_LOCAL_MACHINE\SAM</code></li><li>SECURITY - <code>HKEY_LOCAL_MACHINE\SECURITY</code></li><li>SOFTWARE - <code>HKEY_LOCAL_MACHINE\SOFTWARE</code></li><li>SYSTEM - <code>HKEY_LOCAL_MACHINE\SYSTEM</code></li></ol><p>Las hives que contienen información del usuario son las siguientes (<em>Son archivos ocultos</em>):</p><ol><li>NTUSER.DAT - <code>HKEY_CURRENT_USER</code> cuando un usuario inicia sesión - Se enceuntra en <code>C:\Users\&lt;username></code></li><li>USRCLASS.DAT - <code>HKEY_CURRENT_USER\SOFTWARE\CLASSES</code> - Se encuentra en <code>C:\Users\&lt;username>\AppData\Local\Microsoft\Windows</code></li></ol><h2 id=transaction-logs-y-backups-de-los-registros>Transaction Logs y Backups de los registros</h2><p>Frecuentemente Windows registra las modificaciones realizadas en las hives, estos se encuentran en el mismo directorio donde se almacaena la hive, con el nombre de la hive, son archivos .LOG y se le agrega un número en caso de que sean más de una :v.
Las copias de respaldo son realizadas cada 10 dias. Las copias son guardadas en <code>C:\Windows\System32\Config\RegBack</code>
<img src=/images/windows-forensics/Regbacks.png alt=Regback></p><h2 id=herramientas>Herramientas</h2><h3 id=adquisición>Adquisición</h3><ol><li><a href=https://www.autopsy.com/>Autopsy</a> Dirigirse a la localización y extraer el archivo de la hive.</li><li><a href=https://www.kroll.com/en/services/cyber-risk/incident-response-litigation-support/kroll-artifact-parser-extractor-kape>KAPE</a> Linea de comandos y GUI, seleccionar fuente de donde obtener los registros y el destino en donde se van a copiar.</li><li><a href=https://www.exterro.com/ftk-imager>FTK Imager</a> Dirigirse a la localización y extraer el archivo de la hive.</li></ol><h3 id=visualización>Visualización</h3><ol><li><a href=https://accessdata.com/product-download/registry-viewer-2-0-0>Registry Viewer</a> Similar a regedit, solo puede visualizar una hive a la vez. No toma en cuenta los transaction logs.</li><li><a href=https://ericzimmerman.github.io/#!index.md>Zimmerman&rsquo;s Registry Explorer</a> Permite cargar multiples hives y también utiliza la información de los transaction logs.</li><li><a href=https://github.com/keydet89/RegRipper3.0>RegRipper</a> Recibe un archivo hive como entrada y da como salida un reporte sobre las llaves importantes para forense.</li></ol><h2 id=información-importante>Información importante</h2><p>En la llave <code>SOFTWARE\Microsoft\Windows NT\CurrentVersion</code> podemos consultar la versión del SO de la máquina.</p><h3 id=current-control-set>Current Control Set</h3><p>Las hives donde se almacena la configuración que controla el inicio del sistema, son llamadas Control Set. Comunmente estos son <code>SYSTEM\ControlSet001</code> y <code>SYSTEM\ControlSet002</code>. De donde, la mayoria de los casos ControlSet001 apunta al Control Set con el que la máquina arrancó, mientras que, ControlSet002 es el <code>last known good</code> (la ultima configuración buena conocida).
Por otra parte, Windows crea un Control Set volatil cuando la máquina esta encendida, el cual es <code>HKLM\SYSTEM\CurrentControlSet</code>. Podemos verificar cual Control Set es utilizado como el actual y cual es el <code>last known good</code>, por medio de los valores en el registro de <code>SYSTEM\Current</code> y <code>SYSTEM\LastKnownGood</code> respectivamente.</p><h3 id=nombre-de-la-computadora>Nombre de la computadora</h3><p>Para consultar el nombre de la computadora podemos buscar en la siguiente localización.
<code>SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName</code></p><h3 id=zona-horaria>Zona Horaria</h3><p>Esta información es importante para poder desarrollar una cronología de los eventos ocurridos. Esta se puede consultar en la siguiente localización.
<code>SYSTEM\CurrentControlSet\Control\TimeZoneInformation</code></p><h3 id=interfaces-de-red-y-past-networks>Interfaces de red y past networks?</h3><p>Para consultar la dirección IP, la dirección DHCP IP, la máscara de subred y los servidores DNS, recurrimos a la siguiente localización.
<code>SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces</code>
Si queremos consultar las redes a las que estuvo conectada la máquina, accedemos a las siguientes localizaciones.
<code>SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged</code>
<code>SOFTWARE\Microsoft\WindowsNT\CurrentVersion\NetworkList\Signatures\Managed</code></p><h3 id=programas-con-autoarranque>Programas con autoarranque</h3><p>Los programas o comandos que se ejecutan al momento que un usuario inicia sesión en la máquina se pueden consultar en las siguientes llaves.
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run</code>
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce</code>
<code>SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</code>
<code>SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run</code>
<code>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>
De igual si queremos revisar los servicios que se ejecutan desde que se inicia el sistema, nos dirigimos a <code>SYSTEM\CurrentControlSet\Services</code> para consultar los servicios, depués de seleccionar el que queremos revisar, observamos la llave Start si su valor es 0x02 esto quiere decir que se ejecuta al iniciarse el sistema.</p><h3 id=información-de-los-usuarios>Información de los usuarios</h3><p>En la hive SAM se puede revisar información sobre la cuenta, los grupos y los inicios de sesión. Información de usuario como el ID relativo, cuantas veces inicio sesión un usuario, último inicio de sesión, último intento fallido de inicio, último cambio de contraseña, cuando expira y la pista sobre la contraseña. Todo lo anterior se revisa en:
<code>SAM\Domains\Account\Users</code></p><h3 id=archivos-recientes>Archivos recientes</h3><p>Windows mantiene una lista de archivos abiertos recientemente, de cada usuario. Esta lista la podemos encontrar en la siguiente localización.
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs</code>
De igual forma encontramos llaves que contienen el último archivo de una extensión (como pdf, docx&mldr;) abierto. Por ejemplo.
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.pdf</code>
<strong>Archivos de Office</strong>
Los archivos abiertos recientemente se pueden encontrar en la siguiente localizción.
<code>NTUSER.DAT\Software\Microsoft\Office\VERSION</code>
<strong>ShellBags</strong>
Eric Zimmerman&rsquo;s tools called ShellBag Explorer show us the information from the hive file we have extracted.
<code>USRCLASS.DAT\Local Settings\Software\Microsoft\Windows\Shell\Bags</code>
<code>USRCLASS.DAT\Local Settings\Software\Microsoft\Windows\Shell\BagMRU</code>
<code>NTUSER.DAT\Software\Microsoft\Windows\Shell\BagMRU</code>
<code>NTUSER.DAT\Software\Microsoft\Windows\Shell\Bags</code></p><p><strong>Dialogos de abrir/guardar y último visitado</strong></p><p>Cuando abrimos o guardamos un archivo desde el cuadro de dialogo, podemos consultar los movimientos que realizamos en las siguientes localizaciones.
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePIDlMRU</code>
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\LastVisitedPidlMRU</code></p><p><strong>Barra de busqueda de Windows</strong>
Otra forma de revisar la actividad reciente es mediante las busquedas realizadas por el usuario, estas se pueden encontrar en las siguientes localizaciones.
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths</code>
<code>NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\WordWheelQuery</code></p><h2 id=ejecutables>Ejecutables</h2><p><a href=#registros%20de%20windows>Inicio</a>
<strong>UserAssist (Programas desde Windows Explorer)</strong>
Windows mantiene información acerca de los programas ejecutados desde Windows Explorer, la fecha en que se abrió y el número de veces que se ha abierto. Esta llave se puede encontrar en la siguiente localización. Donde <code>GUID</code> es el ID del usuario.
<code>NTUSER.DAT\Software\Microsoft\Windows\Currentversion\Explorer\UserAssist\{GUID}\Count</code>
<strong>ShimCache (Todas las aplicaciones ejecutadas en la máquina)</strong>
Es un mecanismo usado para dar seguimiento a la compatibilidad de los ejecutables con el sistema operativo.
ShimCache almacena el nombre del archivo, el tamaño del archivo y la última vez que se modifico el ejecutable. Lo podemos encontrar en la siguiente localización.
<code>SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache</code>
Para visualizarlo podemos pasarle la hive <code>SYSTEM</code> a la herramienta AppCompatCacheParser.exe de Eric Zimmerman y obtenemos como salida un archivo csv con el siguiente comando:
<code>AppCompatCacheParser.exe --csv &lt;ruta de salida> -f &lt;ruta de la hive SYSTEM> -c &lt;analizador gramatical utilizado></code>
<strong>AmCache</strong>
Otra hive importante es la de <strong>Amcache</strong> en la cual se almacena información sobre programas ejecutados recientemente, la ubicación del ejecutable, instalación, ejecucion y fecha en que se borró, e incluso las hashes en SHA1 de los programas ejecutados. Se localiza en <code>C:\Windows\AppCompat\Programs\Amcache.hve</code>
<strong>BAM/DAM</strong>
Monitoreo activo en segundo plano (Background Active Monitor), mantiene una lista de las aplicaciones en segundo plano. Moderador de actividad del escritorio (Desktop Activity Moderator) se encarga de optimizar el consumo de energía del dispositivo. Contiene información acerca de los últimos programas ejecutados, sus rutas de ubicación completas y la ultima vez que se ejecutó.
Estos podemos encontrarlos en las siguientes localizaciones.
<code>SYSTEM\CurrentControlSet\Services\bam\UserSettings\{SID}</code>
<code>SYSTEM\CurrentControlSet\Services\dam\UserSettings\{SID}</code></p><h2 id=dispositivos-usb>Dispositivos USB</h2><p><strong>Identificación de dispositivos</strong>
Las siguientes localizaciones almacenan información sobre los dispositivos USB conectados a la máquina. Almacenan el ID del vendedor, el ID del producto y versión del dispositivo USB.
<code>SYSTEM\CurrentControlSet\Enum\USBSTOR</code>
<code>SYSTEM\CurrentControlSet\Enum\USB</code>
<strong>Primera/Última conexión</strong>
En la siguiente localización tenemos distintas opciones de acuerdo al número colocado en &ldquo;####&rdquo;
0064 - Primera conexión
0066 - Última conexión
0067 - Últma vez que se desconectó
<code>SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USBSerial#\Properties\{83da6326-97a6-4088-9453-a19231573b29}\####</code></p><p><strong>Nombre de Volumen del dispositivo USB</strong>
Lo podemos encontrar en la siguiente localización.
<code>SOFTWARE\Microsoft\Windows Portable Devices\Devices</code>
Con esto podemos identificar muy bien los dispositivos USB y concentrarnos en el que nos interesa.</p><h2 id=fuente>Fuente</h2><p><a href=https://tryhackme.com/room/windowsforensics1>Windows Forensics 1 - Tryhackme</a></p></p></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#registros-de-windows>Registros de Windows</a></li><li><a href=#registry-hives-offline>Registry Hives offline</a></li><li><a href=#transaction-logs-y-backups-de-los-registros>Transaction Logs y Backups de los registros</a></li><li><a href=#herramientas>Herramientas</a><ul><li><a href=#adquisición>Adquisición</a></li><li><a href=#visualización>Visualización</a></li></ul></li><li><a href=#información-importante>Información importante</a><ul><li><a href=#current-control-set>Current Control Set</a></li><li><a href=#nombre-de-la-computadora>Nombre de la computadora</a></li><li><a href=#zona-horaria>Zona Horaria</a></li><li><a href=#interfaces-de-red-y-past-networks>Interfaces de red y past networks?</a></li><li><a href=#programas-con-autoarranque>Programas con autoarranque</a></li><li><a href=#información-de-los-usuarios>Información de los usuarios</a></li><li><a href=#archivos-recientes>Archivos recientes</a></li></ul></li><li><a href=#ejecutables>Ejecutables</a></li><li><a href=#dispositivos-usb>Dispositivos USB</a></li><li><a href=#fuente>Fuente</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2022 SSBsb3ZlIHlvdTwz</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>